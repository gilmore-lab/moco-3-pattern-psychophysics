---
title: "group-analysis-children"
author: "Rick O. Gilmore"
date: "`r Sys.time()`"
output: 
  html_document:
    self_contained: false
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
    dpi: 300
    dev: pdf
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE)

# Install packman for subsequent package management
# install.packages("pacman")
if (!("pacman" %in% installed.packages()[,])) {
    install.packages("pacman")
  }
library(pacman)
pacman::p_load(dplyr, ggplot2, knitr, psyphy, lme4, pander)
```

## Background

This document describes the workflow involved in analyzing the motion coherence psychophysics study carried out with child participants.

## Import data

Here we import the aggregate data file found in `analyses/data-aggregate/moco-beh-child.csv`, convert `AgeDays` to a categorical factor, `AgeYrs`, and compute some summary statistics across trial and block. These summary values are saved to the  `df.bysub.bycond` data frame.

```{r import-data}
# Import child data, normalize

df <- read.csv(file = "analyses/data-aggregate/moco-beh-child.csv", header = TRUE)

# Convert age in days to years
df$AgeYrs <- ordered(cut(df$AgeDays/365.25, 
                 breaks = c(0,5,6,7,8,9), 
                 labels = c("<5yo", "5yo", "6yo", "7yo", "8yo")))

df %>% 
  group_by(AgeYrs, Gender, SubID, PatternType, Speed, Coh) %>% 
  summarize(N.corr = sum(Acc), 
            N.tot = n(), 
            Pct.Corr = N.corr/N.tot,
            RT.mean=mean(RT),
            RT.sd=sd(RT)) -> 
  df.bysub.bycond
```

## Tabular summary of participant ages by gender

```{r age-gender-table, include=TRUE}
# Summary table of age/gender dist
df.bysub.bycond %>% 
  group_by(Gender, AgeYrs, SubID) %>% 
  summarize(num = n()) -> df.gender.age
xt <- xtabs(formula = ~ AgeYrs + Gender, data = df.gender.age)
kable(xt)
```

We tested *n*=`r sum(xt)` children overall, (`r sum(xt[,1])` female) between 5 and 8 years of age.

## Histogram of age

```{r age-histogram, include=TRUE}
df %>%
  group_by(AgeYrs, SubID, AgeDays) %>%
  summarize(SubAgeDays = mean(AgeDays)) %>%
  ggplot() +
  aes(x=SubAgeDays/365.25, fill = AgeYrs) + # By years?
  geom_histogram() +
  xlab("Age in Years")
```

## Violin plot of age by sex

```{r age-sex-violin, include=TRUE}
theme.custom <- theme(plot.title = element_text(size=16, face="bold"),
                      axis.title.x = element_text(size=14),
                      axis.title.y = element_text(size=14),
                      strip.text = element_text(size=14),
                      axis.text = element_text(size=11),
                      legend.position="bottom", 
                      legend.title=element_blank(),
                      legend.text=element_text(size=11))

df %>%
  group_by(AgeYrs, Gender, SubID, AgeDays) %>%
  summarize(SubAgeDays = mean(AgeDays)) %>%
  ggplot() +
  aes(x=Gender, y=SubAgeDays/365.25) + # By years?
  # geom_boxplot() +
  geom_violin() +
  geom_point(aes(color=AgeYrs, size=1)) +
  ylab("Age in Years") +
  theme_bw() +
  theme.custom +
  guides(size=FALSE)
```


## Plot of *p*(corr) by condition

```{r p-corr-pattern-speed-plot, include=TRUE}
  # Plot theme, customizations

y_lbl <- 'p(corr)'
title_text <- 'p(corr) by Coherence, Pattern, and Speed'
df.bysub.bycond$Speed <- factor(df.bysub.bycond$Speed, labels = c("2 deg/s", "8 deg/s"))

# Plot for all subs
p <- ggplot(data=df.bysub.bycond, aes(x=Coh, y=Pct.Corr)) 
p <- p + 
  geom_line(aes(group=SubID, color=AgeYrs)) +
  facet_grid(facets = Speed ~ PatternType) +
  labs(x="Coherence", y=y_lbl) +
  #ggtitle(title_text) +
  theme_bw() +
  theme.custom +
  xlim(0, 1) +
  geom_hline(yintercept=0.5, linetype="dashed")
p
```

The proportion correct responses generally increase with increasing coherence. There is a hint that younger children are less accurate.

## Plot of reaction time

```{r rt-pattern-speed-plot, include=TRUE}
# Plot RTs
y_lbl <- 'RT (s)'
title_text <- 'RT by Coherence, Pattern, and Speed'

# Plot for all subs
p <- ggplot(data=df.bysub.bycond, aes(x=Coh, y=RT.mean))
p <- p + 
  geom_line(aes(group=SubID, color=AgeYrs)) +
  facet_grid(facets = Speed ~ PatternType) +
  labs(x="Coherence", y=y_lbl) +
  # ggtitle(title_text) +
  theme_bw() +
  theme.custom +
  xlim(0, 1)
p 
``` 

Reaction times generally decrease with increasing coherence. There is evidence that younger children are slower.

## Plot of speed across patterns by age

```{r p-corr-by-speed-and-age-plot}
# Evaluate Speed by Coherence interaction
spd.by.coh <- df.bysub.bycond %>%
  group_by(Speed, Coh, AgeYrs) %>%
  summarize(Pct.Corr.mean = mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.sem = sd(Pct.Corr, na.rm=TRUE)/sqrt( n() ))

limits = aes( ymax = Pct.Corr.mean + Pct.Corr.sem , ymin = Pct.Corr.mean - Pct.Corr.sem )

p6 <- 
  ggplot( data=spd.by.coh, aes(x=Coh, y=Pct.Corr.mean, color = AgeYrs) ) +
  facet_grid( facets = . ~ Speed ) +
  geom_line() +
  geom_pointrange( limits ) +
  xlim(0,1) +
  ylim(.4, 1) +
  ylab("p(corr)") +
  xlab("Coherence)") +
  theme_bw() +
  theme.custom +
  geom_hline(yintercept=0.5, linetype="dashed")
p6
```

## Plot of coherence by pattern across age

```{r p-corr-by-pattern-and-age-plot, include=TRUE}
patt.by.coh <- df.bysub.bycond %>%
  group_by(PatternType, Coh, AgeYrs) %>%
  summarize(Pct.Corr.mean = mean(Pct.Corr, na.rm=TRUE),
            Pct.Corr.sem = sd(Pct.Corr, na.rm=TRUE)/sqrt( n() ))

limits = aes( ymax = Pct.Corr.mean + Pct.Corr.sem , ymin = Pct.Corr.mean - Pct.Corr.sem )

p7 <- 
  ggplot( data=patt.by.coh, aes(x=Coh, y=Pct.Corr.mean, color = AgeYrs) ) +
  facet_grid( facets = ~ PatternType ) +
  geom_line() +
  geom_pointrange( limits ) +
  xlim(0, 1) +
  ylim(.4, 1) +
  ylab("p(corr)") +
  xlab("Coherence)") +
  theme_bw() +
  theme.custom +
  geom_hline(yintercept=0.5, linetype="dashed")
p7
```

### RT by speed across patterns

```{r rt-by-speed-and-age-plot, include=TRUE}
# Evaluate Speed by Coherence interaction
spd.by.coh.rt <- df.bysub.bycond %>%
  group_by(Speed, Coh, AgeYrs) %>%
  summarize(RT.Cond.mean = mean(RT.mean, na.rm=TRUE),
            RT.sem = sd(RT.sd, na.rm=TRUE)/sqrt( n() ))

limits = aes(ymax = RT.Cond.mean + RT.sem, ymin = RT.Cond.mean - RT.sem)

p.rt <- 
  ggplot( data=spd.by.coh.rt, aes(x=Coh, y=RT.Cond.mean, color = AgeYrs)) +
  facet_grid( facets = . ~ Speed ) +
  geom_line() +
  geom_pointrange( limits ) +
  xlim(0,1) +
  ylab("RT (s)") +
  xlab("Coherence") +
  theme_bw() +
  theme.custom
p.rt
```

## RT by pattern across age

```{r rt-by-pattern-and-age-plot}
patt.by.coh.rt <- df.bysub.bycond %>%
  group_by(PatternType, Coh, AgeYrs) %>%
  summarize(RT.Cond.mean = mean(RT.mean, na.rm=TRUE),
            RT.sem = sd(RT.sd, na.rm=TRUE)/sqrt( n() ))

limits = aes(ymax = RT.Cond.mean + RT.sem, ymin = RT.Cond.mean - RT.sem)

p7 <- 
  ggplot( data=patt.by.coh.rt, aes(x=Coh, y=RT.Cond.mean, color = AgeYrs)) +
  facet_grid( facets = ~ PatternType ) +
  geom_line() +
  geom_pointrange( limits ) +
  xlim(0, 1) +
  ylab("RT (s)") +
  xlab("Coherence") +
  theme_bw() +
  theme.custom
p7
```

## Probit analysis

### Full model

```{r probit-full, eval=FALSE}
form.full <- Acc ~ AgeYrs * Coh * Speed * PatternType + (1|SubID)
mod.full <- glmer(formula = form.full, family=binomial(mafc.probit(2)), data = df)
```

```{r summary.full.model, eval=FALSE}
summary(mod.full)
```

The full model fails to converge, so let's fit a model without `AgeYrs` than add back in those effects.

### Drop age

```{r probit-drop-age, eval=FALSE}
form.drop.age <- Acc ~ Coh * Speed * PatternType + (1|SubID)
mod.drop.age <- glmer(formula = form.drop.age, family=binomial(mafc.probit(2)), data = df)
```

This model also fails to converge, so let's choose specific effects that appear to characterize the fits. 

### Drop high level interactions

```{r probit-drop-age-3-way}
form.drop.three.way <- Acc ~ Coh + Speed + PatternType + Coh:Speed + Coh:PatternType + (1|SubID)
mod.drop.three.way <- glmer(formula = form.drop.three.way, family=binomial(mafc.probit(2)), data = df)
```

Model converges.

```{r summary-probit-drop-3-way}
summary(mod.drop.three.way)
```

Can we drop main effect of `Speed`?

### Drop main effect of `Speed`

```{r probit-drop-speed}
form.drop.speed <- Acc ~ Coh + PatternType + Coh:Speed + Coh:PatternType + (1|SubID)
mod.drop.speed <- update(mod.drop.three.way, formula = form.drop.speed)
```

Model converges.

```{r summary-drop-speed}
summary(mod.drop.speed)
anova(mod.drop.three.way, mod.drop.speed)
```

There is no significant difference between the full(er) and reduced model.
Let's examine the effect of dropping the `Coh:Pattern` interaction.

### Drop `Coh:Pattern` interaction

```{r probit-drop-coh-patt-int}
drop.coh.patt.int <- Acc ~ Coh + PatternType + Coh:Speed + (1|SubID)
mod.drop.coh.patt.int <- update(mod.drop.three.way, formula=drop.coh.patt.int)
```

Model converges.

```{r, summ-drop-coh-patt-int}
summary(mod.drop.coh.patt.int)
anova(mod.drop.three.way, mod.drop.coh.patt.int)
```

This also does not improve the fit. So, we keep the interaction term.

### Table for best-fitting model (without age)

```{r best-probit-fit-table, results="asis", eval=FALSE}
# Neither pander nor xtable had appropriate methods to print the table

# pander(mod.drop.three.way)
# print(xtable(mod.drop.three.way), type = "html")
```

### Add age back in to best model

```{r probit-age-back-in}
age.main <- Acc ~ AgeYrs + Coh + Speed + PatternType + Coh:Speed + Coh:PatternType + (1|SubID)
mod.age.main <- update(mod.drop.three.way, formula=age.main)
```

```{r summary-age-plus}
summary(mod.age.main)
```

Is age needed?

```{r need-age}
anova(mod.age.main, mod.drop.three.way)
```
 
Yes, the goodness of fit dropped substantially $\chi^2(3)=$24.783, $p$=1.7x$10^{-5}$ in comparing the model without `AgeYrs` to the model that includes it. 

## Copy figure files

```{r copy-figs}

```